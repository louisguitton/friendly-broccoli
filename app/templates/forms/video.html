{% extends 'layouts/main.html' %}
{% block title %}Apply{% endblock %}

{% block head %}
    <link href="{{ url_for('static', filename='node_modules/video.js/dist/video-js.min.css')}}" rel="stylesheet">
    <link href="{{ url_for('static', filename='node_modules/videojs-record/dist/css/videojs.record.css')}}" rel="stylesheet">

    <script src="{{ url_for('static', filename='node_modules/video.js/dist/video.min.js')}}"></script>
    <script src="{{ url_for('static', filename='node_modules/recordrtc/RecordRTC.js')}}"></script>
    <script src="{{ url_for('static', filename='node_modules/webrtc-adapter/out/adapter.js')}}"></script>

    <script src="{{ url_for('static', filename='node_modules/videojs-record/dist/videojs.record.js')}}"></script>

    <style>
    /* change player background color */
    #myVideo {
        background-color: #9ab87a;
    }
    </style>
{% endblock %}


{% block content %}
<div id="main" role="main" class="apply">
	<div class="row">
		<div class="col-sm-4">
			<h1>
				Apply
			</h1>
			<p class="text-muted step">(step {{ question_id + 1 }} of {{ global_data["VIDEOS"]|length + 1 }})</p>
		</div><!-- /.col -->
		<div class="col-sm-8">
			<div id="intro" style="display:{{ 'none' if question_id != 1 else 'inherit' }}">
				<div class="alert alert-success">
					<b>Thanks!</b>
				</div>
				<p>Next, we'd like to ask you
                    {{ 'a question' if global_data["VIDEOS"]|length == 1 else 'some questions' }},
				   which you can respond to using the embedded video recorder.
                   The {{ 'question is' if global_data["VIDEOS"]|length == 1 else 'questions are' }}:</p>
				<ol>
				{% for video in global_data["VIDEOS"] %}
					<li><b>{{ video["question"] }}</b>
					</li>
				{% endfor %}
				</ol>

				<p>When you're ready, continue to the next screen where you can start the video recorder.</p>
				
				<div style="text-align:center">
					<a class="btn btn-large btn-primary" id="lets-go">Ready? Let's go</a>
				</div>


			</div><!-- /#intro -->

			<div id="apply-form-container" style="display:{{ 'none' if question_id == 1 else 'inherit' }}">
				<form method="POST" action="/apply" id="apply-form">		
					<input type="hidden" name="state" value="{{ question_id }}" />
					<div class="well interview-question">
						<h2>{{ global_data['VIDEOS'][question_id - 1]["question"] }}</h2>
						<p class="text-muted" style="font-size: 1.2em">(up to {{ global_data['VIDEOS'][question_id - 1]["limit"] }} seconds)</p>
                    </div>
                    
                    <video id="myVideo" class="video-js vjs-default-skin"></video>

                    <script>
                        var video_settings_js = {{ video_settings|tojson }};
                        var player = videojs("myVideo", video_settings_js, function onPlayerReady(){
                            // print version information at startup
                            var msg = 'Using video.js ' + videojs.VERSION +
                                ' with videojs-record ' + videojs.getPluginVersion('record') +
                                ' and recordrtc ' + RecordRTC.version;
                            videojs.log(msg);
                        });

                        // error handling
                        player.on('deviceError', function() {
                            console.log('device error:', player.deviceErrorCode);
                        });
                        player.on('error', function(error) {
                            console.log('error:', error);
                        });
                        
                        // user clicked the record button and started recording
                        player.on('startRecord', function() {
                            console.log('started recording!');
                        });

                        function upload(blob) {
                            var serverUrl = '/upload';

                            var formData = new FormData();
                            formData.append('file', blob, blob.name);

                            console.log('uploading recording:', blob.name);

                            fetch(serverUrl, {
                                method: 'POST',
                                body: formData
                            }).then(
                                success => console.log('recording upload complete.')
                            ).catch(
                                error => console.error('an upload error occurred!')
                            );
                        }
                        
                        // user completed recording and stream is available
                        player.on('finishRecord', function() {
                            // the blob object contains the recorded data that
                            // can be downloaded by the user, stored on server etc.
                            console.log('finished recording: ', player.recordedData);
            
                            var data = this.recordedData;
                            if (this.recordedData.video) {
                                // for chrome for audio+video
                                data = this.recordedData.video;
                            }

                            console.log("blob", data);

                            upload(data);
                        });
                    </script>

					
					<div class="alert alert-info" id="superwarn" style="display:none;">
						<b>Great!</b> Note: once you hit "continue" you will not be able to come back to this question.
					</div>
					
					{% if not global_data['VIDEOS'][question_id - 1]["required"] %}
						<input class="btn btn-large pull-right" type="submit" value="Skip" id="skip" />
					{% endif %}
					
					<input class="btn btn-large btn-primary pull-right" type="submit" value="Continue" id="submit" style="display:none" />
				</form>
			</div><!-- /.apply-form-container -->
		</div>
		
	</div><!-- /.row -->
</div>
{% endblock %}


{% block javascript %}
<script>
$(document).ready(function () {
	$('#lets-go').click(function(e) {
		e.preventDefault();
		$('#apply-form-container').slideDown();
		$('#intro').slideUp();
	});
	// ZiggeoApi.Events.on("submitted", function () {
	// 	 $("#skip").hide();
	// 	 $('#superwarn').show();
	// 	 $("#submit").show();
	// });
	
	
});
</script>
{% endblock %}